name: üöÄ Build & Deploy GoTalk API

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  K8S_NAMESPACE: gotalk
  K8S_DEPLOYMENT: gotalk-api

jobs:
  # ============================================================
  # JOB 1: Build & Push Docker Image l√™n Docker Hub
  # ============================================================
  build-and-push:
    name: üê≥ Build & Push Docker Image
    runs-on: ubuntu-latest

    outputs:
      # Ch·ªâ output image_tag (chu·ªói thu·∫ßn, kh√¥ng ch·ª©a secret)
      # VD: v260220.5
      image_tag: ${{ steps.meta.outputs.version }}

    steps:
      - name: üì• Checkout source code
        uses: actions/checkout@v4

      # T·∫°o image tag theo format: v{YYMMDD}.{run_number}
      - name: üè∑Ô∏è Generate image tag
        id: meta
        run: |
          DATE=$(date +'%y%m%d')
          TAG="v${DATE}.${{ github.run_number }}"
          echo "version=${TAG}" >> $GITHUB_OUTPUT
          echo "üì¶ Image tag: ${TAG}"

      - name: üîê Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üõ†Ô∏è Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üèóÔ∏è Build and Push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          target: production
          push: true
          # D√πng tr·ª±c ti·∫øp secret ·ªü ƒë√¢y (trong c√πng job) ‚Üí KH√îNG b·ªã mask
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/gotalk-api:${{ steps.meta.outputs.version }}
            ${{ secrets.DOCKERHUB_USERNAME }}/gotalk-api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ‚úÖ Image pushed successfully
        run: |
          echo "üéâ Image pushed: ${{ secrets.DOCKERHUB_USERNAME }}/gotalk-api:${{ steps.meta.outputs.version }}"

  # ============================================================
  # JOB 2: Deploy l√™n VPS qua SSH (kubectl set image)
  # ============================================================
  deploy:
    name: üöÄ Deploy to VPS (Kubernetes)
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name:  SSH into VPS and deploy
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: 22
          # Truy·ªÅn bi·∫øn v√†o SSH session qua envs thay v√¨ n·ªôi suy trong script
          # ‚Üí tr√°nh b·ªã GitHub mask do ch·ª©a secret value
          envs: IMAGE_TAG,DOCKERHUB_USERNAME,K8S_NAMESPACE,K8S_DEPLOYMENT
          script: |
            set -e

            # Gh√©p image name t·ª´ envs ƒë∆∞·ª£c truy·ªÅn v√†o SSH session
            NEW_IMAGE="${DOCKERHUB_USERNAME}/gotalk-api:${IMAGE_TAG}"

            echo "üöÄ Deploying: ${NEW_IMAGE}"
            echo "üì¶ Namespace: ${K8S_NAMESPACE} | Deployment: ${K8S_DEPLOYMENT}"

            kubectl set image deployment/${K8S_DEPLOYMENT} \
              api=${NEW_IMAGE} \
              --namespace=${K8S_NAMESPACE}

            echo "‚è≥ Waiting for rollout to complete..."
            kubectl rollout status deployment/${K8S_DEPLOYMENT} \
              --namespace=${K8S_NAMESPACE} \
              --timeout=180s

            echo "‚úÖ Deployment successful!"
            echo "üìã Current pods:"
            kubectl get pods --namespace=${K8S_NAMESPACE} -l app=${K8S_DEPLOYMENT}
        env:
          IMAGE_TAG: ${{ needs.build-and-push.outputs.image_tag }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          K8S_NAMESPACE: ${{ env.K8S_NAMESPACE }}
          K8S_DEPLOYMENT: ${{ env.K8S_DEPLOYMENT }}

      - name: üéâ Deploy completed
        run: |
          echo "‚úÖ GoTalk API deployed!"
          echo "üñºÔ∏è  Image tag: ${{ needs.build-and-push.outputs.image_tag }}"
