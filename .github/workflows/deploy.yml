name: ğŸš€ Build & Deploy GoTalk API

on:
  push:
    branches:
      - main        # Trigger deploy khi push lÃªn main
      - master      # Hoáº·c master tÃ¹y repo cá»§a báº¡n
  workflow_dispatch: # Cho phÃ©p trigger thá»§ cÃ´ng tá»« GitHub UI

env:
  # Docker Hub image name - THAY báº±ng Docker Hub username cá»§a báº¡n
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/gotalk-api
  # Namespace Kubernetes trÃªn VPS
  K8S_NAMESPACE: gotalk
  # TÃªn Deployment trÃªn Kubernetes
  K8S_DEPLOYMENT: gotalk-api

jobs:
  # ============================================================
  # JOB 1: Build & Push Docker Image lÃªn Docker Hub
  # ============================================================
  build-and-push:
    name: ğŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest

    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
      full_image: ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}

    steps:
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4

      # Táº¡o image tag theo format: v{YYMMDD}.{run_number} Ä‘á»ƒ dá»… trace
      # VD: v260220.5
      - name: ğŸ·ï¸ Generate image tag
        id: meta
        run: |
          DATE=$(date +'%y%m%d')
          TAG="v${DATE}.${{ github.run_number }}"
          echo "version=${TAG}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Image tag: ${TAG}"

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Setup QEMU vÃ  Buildx Ä‘á»ƒ support multi-platform (optional nhÆ°ng tá»‘t cho production)
      - name: ğŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build and Push image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          # Build target "production" (stage 3 trong Dockerfile cá»§a báº¡n)
          target: production
          push: true
          # Push 2 tags: version cá»¥ thá»ƒ + latest
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
            ${{ env.IMAGE_NAME }}:latest
          # Cache layers Ä‘á»ƒ build nhanh hÆ¡n á»Ÿ láº§n sau
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: âœ… Image pushed successfully
        run: |
          echo "ğŸ‰ Image pushed: ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}"

  # ============================================================
  # JOB 2: Deploy lÃªn VPS qua SSH (kubectl set image)
  # ============================================================
  deploy:
    name: ğŸš€ Deploy to VPS (Kubernetes)
    runs-on: ubuntu-latest
    needs: build-and-push  # Chá»‰ cháº¡y sau khi build thÃ nh cÃ´ng

    steps:
      - name: ğŸ“¥ Checkout source code
        uses: actions/checkout@v4

      - name: ğŸ”— SSH into VPS and deploy
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          # DÃ¹ng SSH private key (khuyÃªn dÃ¹ng) thay cho password
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          # Script cháº¡y trá»±c tiáº¿p trÃªn VPS
          script: |
            set -e

            NEW_IMAGE="${{ needs.build-and-push.outputs.full_image }}"
            NAMESPACE="${{ env.K8S_NAMESPACE }}"
            DEPLOYMENT="${{ env.K8S_DEPLOYMENT }}"

            echo "ğŸš€ Deploying: ${NEW_IMAGE}"
            echo "ğŸ“¦ Namespace: ${NAMESPACE} | Deployment: ${DEPLOYMENT}"

            # Cáº­p nháº­t image cho container "api" trong deployment
            kubectl set image deployment/${DEPLOYMENT} \
              api=${NEW_IMAGE} \
              --namespace=${NAMESPACE}

            # Chá» rollout hoÃ n thÃ nh (timeout 3 phÃºt)
            echo "â³ Waiting for rollout to complete..."
            kubectl rollout status deployment/${DEPLOYMENT} \
              --namespace=${NAMESPACE} \
              --timeout=180s

            echo "âœ… Deployment successful!"
            echo "ğŸ“‹ Current pods:"
            kubectl get pods --namespace=${NAMESPACE} -l app=${DEPLOYMENT}

      - name: ğŸ‰ Deploy completed
        run: |
          echo "âœ… GoTalk API deployed successfully!"
          echo "ğŸ–¼ï¸ Image: ${{ needs.build-and-push.outputs.full_image }}"
